name: Create new release

on:
  - push
  - pull_request

jobs:
  rpm:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: Install packages
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-dev \
            python3-venv \
            rpm
      - name: Set up Python 3.6
        uses: actions/setup-python@v2
        with:
          python-version: '3.6'
          architecture: 'x64'
      - name: Install dependencies
        id: install-deps
        run: |
          python -m pip install --upgrade pip
          pip install \
            virtualenv \
            venvctrl
          mkdir /var/tmp/BUILD /var/tmp/SOURCES /var/tmp/SRPMS/ /var/tmp/RPMS
      - name: Build RPM
        id: rpm-build
        run: rpmbuild --bb snooze-server.spec
      - name: package_path
        run: echo "::set-output name=package_path::$(echo /var/tmp/RPMS/x86_64/snooze-server-$(cat VERSION)-1.x86_64.rpm)"
        id: package_path
      - name: package_name
        run: echo "::set-output name=package_name::$(echo snooze-server-$(cat VERSION)-1.x86_64.rpm)"
        id: package_name
      - name: upload
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ steps.package_path.outputs.package_path }}
          asset_name: ${{ steps.package_name.outputs.package_name }}
          tag: ${{ github.ref }}
          overwrite: true
